name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npm run lint -- --max-warnings 120
        name: Lint
      - run: npx tsc --noEmit
        name: Type Check
      - run: npm test
        name: Test
        env:
          VITE_SUPABASE_URL: https://example.supabase.co
          VITE_SUPABASE_PUBLISHABLE_KEY: dummy-key-for-test
      - run: npm run build
        name: Build
        env:
          VITE_SUPABASE_URL: https://example.supabase.co
          VITE_SUPABASE_ANON_KEY: dummy-key-for-build

  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: pip install -r requirements.txt
      - run: pip install pytest
      - run: pytest tests/ -v
        name: Run Tests
        env:
          GOOGLE_API_KEY: dummy
          MAP_GOOGLE_API_KEY: dummy

  edge-functions:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/supabase/functions/_shared
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - run: deno test
        name: Test

  docker:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lambda: [gateway, downloader, worker, mail_handler]
    steps:
      - uses: actions/checkout@v4
      - run: docker build -f lambda_${{ matrix.lambda }}/Dockerfile .
        name: Build ${{ matrix.lambda }}
